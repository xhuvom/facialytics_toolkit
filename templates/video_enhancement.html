<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Enhancement - CodeFormer Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <div class="container">
    <div class="main-content">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <h1><i class="fas fa-magic"></i> CodeFormer Portal</h1>
          <img src="{{ url_for('static', filename='images/sigmind.png') }}" alt="Sigmind Logo" class="header-logo">
        </div>
      </div>

      <!-- Navigation -->
      <div class="nav-container">
        <ul class="nav-tabs">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('landing') }}">
              <i class="fas fa-home"></i>
              Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'restoration' %}active{% endif %}" href="{{ url_for('index') }}">
              <i class="fas fa-wand-magic-sparkles"></i>
              Face Restoration
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'inpainting_drawing' %}active{% endif %}" href="{{ url_for('inpainting_drawing') }}">
              <i class="fas fa-paintbrush"></i>
              Inpainting/Drawing
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'comparison' %}active{% endif %}" href="{{ url_for('compare') }}">
              <i class="fas fa-balance-scale"></i>
              Face Comparison
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'video_enhancement' %}active{% endif %}" href="{{ url_for('video_enhancement') }}">
              <i class="fas fa-video"></i>
              Video Enhancement
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'face_recognition' %}active{% endif %}" href="{{ url_for('face_recognition') }}">
              <i class="fas fa-search"></i>
              Face Recognition
            </a>
          </li>
        </ul>
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <div class="page-header fade-in">
          <h1 class="page-title">Video Enhancement</h1>
          <p class="page-subtitle">Enhance video quality with advanced AI face restoration technology</p>
        </div>

        <div class="row">
          <div class="col-lg-8 mx-auto">
            <div class="card fade-in">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-video"></i>
                  Upload & Enhance Video
                </h3>
              </div>
              <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="videoForm">
                  <div class="form-group">
                    <label for="video_file" class="form-label">
                      <i class="fas fa-film"></i>
                      Select Video File
                    </label>
                    <div class="form-control-file" onclick="document.getElementById('video_file').click()">
                      <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                      <p class="mb-1">Click to upload or drag and drop</p>
                      <p class="text-muted small">Supports: MP4, AVI, MOV (Max 500MB)</p>
                      <input type="file" id="video_file" name="video_file" accept="video/*" required style="display: none;">
                    </div>
                    <div id="videoPreview" class="mt-3" style="display: none;">
                      <video id="previewVideo" class="video-player" controls>
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                      </video>
                    </div>
                  </div>
                  <div class="form-group text-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                      <i class="fas fa-magic"></i>
                      Enhance Video
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Error Messages -->
            {% if error_message %}
            <div class="card mt-4 fade-in">
              <div class="card-body">
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle"></i>
                  {{ error_message }}
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Loading Indicator -->
            <div id="loadingIndicator" style="display: none;" class="card mt-4 fade-in">
              <div class="card-body text-center">
                <div class="loading-spinner mb-3"></div>
                <h4>Enhancing Video...</h4>
                <p class="text-muted">This process may take several minutes depending on video length and quality</p>
                <div class="progress-container mt-3">
                  <div class="progress-bar" style="width: 0%">0%</div>
                </div>
              </div>
            </div>

            <!-- Enhanced Video -->
            {% if enhanced_video %}
            <div class="card mt-4 fade-in">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-check-circle text-success"></i>
                  Enhancement Complete
                </h3>
              </div>
              <div class="card-body">
                <div class="video-container">
                  <h4 class="mb-3">Enhanced Video</h4>
                  <video controls class="video-player">
                    <source src="{{ enhanced_video }}" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                  <div class="mt-3 text-center">
                    <a href="{{ enhanced_video }}" download class="btn btn-outline">
                      <i class="fas fa-download"></i>
                      Download Enhanced Video
                    </a>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            {% if terminal_output %}
            <div class="card mt-4 fade-in">
              <div class="card-header d-flex justify-between align-center">
                <h3 class="card-title m-0">
                  <i class="fas fa-terminal"></i>
                  Debug Output
                </h3>
                <button type="button" class="btn btn-outline" onclick="toggleDebug()">
                  <i class="fas fa-eye"></i>
                  Toggle View
                </button>
              </div>
              <div class="card-body" id="debugPanel" style="display: none;">
                <pre class="terminal-output" style="background:#0b1020;color:#e5e7eb;padding:1rem;border-radius:8px;max-height:360px;overflow:auto;white-space:pre-wrap;">{{ terminal_output }}</pre>
              </div>
            </div>
            {% endif %}

            <!-- Features Section -->
            <div class="row mt-5">
              <div class="col-12">
                <h2 class="text-center mb-4">Video Enhancement Features</h2>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <div class="card h-100 text-center">
                      <div class="card-body">
                        <i class="fas fa-face-smile fa-3x text-primary mb-3"></i>
                        <h5>Face Restoration</h5>
                        <p class="text-muted">Automatically detects and enhances facial features in videos</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <div class="card h-100 text-center">
                      <div class="card-body">
                        <i class="fas fa-expand fa-3x text-secondary mb-3"></i>
                        <h5>Quality Upscaling</h5>
                        <p class="text-muted">Improves overall video quality with advanced upscaling technology</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <div class="card h-100 text-center">
                      <div class="card-body">
                        <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                        <h5>Batch Processing</h5>
                        <p class="text-muted">Process multiple videos efficiently with background processing</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Processing Info -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">
                      <i class="fas fa-info-circle"></i>
                      Processing Information
                    </h3>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <h5><i class="fas fa-cog text-primary"></i> Processing Details</h5>
                        <ul class="list-unstyled">
                          <li><i class="fas fa-check text-success"></i> Face detection and alignment</li>
                          <li><i class="fas fa-check text-success"></i> Quality enhancement</li>
                          <li><i class="fas fa-check text-success"></i> Background upscaling</li>
                          <li><i class="fas fa-check text-success"></i> Output optimization</li>
                        </ul>
                      </div>
                      <div class="col-md-6">
                        <h5><i class="fas fa-clock text-warning"></i> Time Estimates</h5>
                        <ul class="list-unstyled">
                          <li><i class="fas fa-info text-info"></i> Short videos (1-5 min): 2-5 minutes</li>
                          <li><i class="fas fa-info text-info"></i> Medium videos (5-15 min): 5-15 minutes</li>
                          <li><i class="fas fa-info text-info"></i> Long videos (15+ min): 15+ minutes</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>Powered by <b>Sigmind.ai</b> | Advanced AI Video Enhancement Technology</p>
      </div>
    </div>
  </div>

  <script>
    // Toggle debug panel
    function toggleDebug(){
      const el = document.getElementById('debugPanel');
      if(!el) return;
      el.style.display = (el.style.display === 'none') ? 'block' : 'none';
    }

    // Video preview functionality
    document.getElementById('video_file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        console.log('[VideoEnhancement] File selected:', file.name, (file.size/1024/1024).toFixed(2)+'MB');
        const url = URL.createObjectURL(file);
        const video = document.getElementById('previewVideo');
        video.src = url;
        document.getElementById('videoPreview').style.display = 'block';
      }
    });

    // Form submission with loading
    document.getElementById('videoForm').addEventListener('submit', function() {
      const file = document.getElementById('video_file').files[0];
      if(file){
        console.log('[VideoEnhancement] Starting enhancement for', file.name, (file.size/1024/1024).toFixed(2)+'MB');
      } else {
        console.log('[VideoEnhancement] No file selected');
      }
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('loadingIndicator').style.display = 'block';
      
      // Simulate progress updates
      let progress = 0;
      const progressBar = document.querySelector('.progress-bar');
      const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
        console.log('[VideoEnhancement] Client progress ~', Math.round(progress)+'%');
      }, 1000);
      
      // Store interval for cleanup
      window.progressInterval = progressInterval;
    });

    // Drag and drop functionality
    const dropZone = document.querySelector('.form-control-file');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      dropZone.style.borderColor = 'var(--primary-color)';
      dropZone.style.background = 'var(--bg-tertiary)';
    }

    function unhighlight(e) {
      dropZone.style.borderColor = 'var(--border-color)';
      dropZone.style.background = 'var(--bg-secondary)';
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      document.getElementById('video_file').files = files;
      
      if (files.length > 0) {
        console.log('[VideoEnhancement] File dropped:', files[0].name, (files[0].size/1024/1024).toFixed(2)+'MB');
        const url = URL.createObjectURL(files[0]);
        const video = document.getElementById('previewVideo');
        video.src = url;
        document.getElementById('videoPreview').style.display = 'block';
      }
    }

    // Clean up progress interval if page is unloaded
    window.addEventListener('beforeunload', function() {
      if (window.progressInterval) {
        clearInterval(window.progressInterval);
      }
    });
  </script>
</body>
</html>