<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Inpainting - CodeFormer Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <div class="container">
    <div class="main-content">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <h1><i class="fas fa-magic"></i> CodeFormer Portal</h1>
          <img src="{{ url_for('static', filename='images/sigmind.png') }}" alt="Sigmind Logo" class="header-logo">
        </div>
      </div>

      <!-- Navigation -->
      <div class="nav-container">
        <ul class="nav-tabs">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('landing') }}">
              <i class="fas fa-home"></i>
              Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'restoration' %}active{% endif %}" href="{{ url_for('index') }}">
              <i class="fas fa-wand-magic-sparkles"></i>
              Face Restoration
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'inpainting_drawing' %}active{% endif %}" href="{{ url_for('inpainting_drawing') }}">
              <i class="fas fa-paintbrush"></i>
              Inpainting/Drawing
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'comparison' %}active{% endif %}" href="{{ url_for('compare') }}">
              <i class="fas fa-balance-scale"></i>
              Face Comparison
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'video_enhancement' %}active{% endif %}" href="{{ url_for('video_enhancement') }}">
              <i class="fas fa-video"></i>
              Video Enhancement
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'face_recognition' %}active{% endif %}" href="{{ url_for('face_recognition') }}">
              <i class="fas fa-search"></i>
              Face Recognition
            </a>
          </li>
        </ul>
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <div class="page-header fade-in">
          <h1 class="page-title">Face Inpainting</h1>
          <p class="page-subtitle">Draw masks and inpaint facial areas using advanced AI technology</p>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card fade-in">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-upload"></i>
                  Upload Image
                </h3>
              </div>
              <div class="card-body">
                <form action="{{ url_for('inpainting_drawing') }}" method="POST" enctype="multipart/form-data" id="inpaintForm">
                  <div class="form-group">
                    <label for="face_image" class="form-label">
                      <i class="fas fa-image"></i>
                      Select Face Image
                    </label>
                    <div class="form-control-file" onclick="document.getElementById('face_image').click()">
                      <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                      <p class="mb-1">Click to upload or drag and drop</p>
                      <p class="text-muted small">Supports: PNG, JPG, JPEG</p>
                      <input type="file" id="face_image" name="face_image" accept="image/*" required style="display: none;">
                    </div>
                  </div>
                  <div class="form-group text-center">
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-magic"></i>
                      Inpaint Face
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card fade-in">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-paintbrush"></i>
                  Drawing Tools
                </h3>
              </div>
              <div class="card-body">
                <div class="drawing-controls">
                  <div class="brush-controls">
                    <label for="brushSize" class="form-label mb-0">Brush Size:</label>
                    <input type="range" id="brushSize" min="1" max="20" value="5" class="custom-range" style="width: 100px;">
                    <span id="brushSizeValue" class="font-weight-bold">5</span>
                  </div>
                  <button id="drawMode" class="btn btn-success">
                    <i class="fas fa-pen"></i>
                    Draw Mode (D)
                  </button>
                  <button id="cropMode" class="btn btn-warning">
                    <i class="fas fa-crop"></i>
                    Crop Mode (C)
                  </button>
                  <button id="clearCanvas" class="btn btn-danger">
                    <i class="fas fa-eraser"></i>
                    Clear
                  </button>
                  <button id="save" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save (S)
                  </button>
                </div>
                <div class="canvas-container">
                  <canvas id="canvas" class="canvas"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        {% if output_image %}
        <div class="row mt-4">
          <div class="col-12">
            <div class="card fade-in">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-check-circle text-success"></i>
                  Inpainting Complete
                </h3>
              </div>
              <div class="card-body text-center">
                <h4 class="mb-3">Inpainted Image</h4>
                <img src="{{ output_image }}" alt="Inpainted Face" class="image-preview shadow-lg">
                <div class="mt-3">
                  <a href="{{ output_image }}" download class="btn btn-outline">
                    <i class="fas fa-download"></i>
                    Download Result
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Instructions -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-info-circle"></i>
                  How to Use
                </h3>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <h5><i class="fas fa-upload text-primary"></i> Upload Image</h5>
                    <p class="text-muted">Start by uploading a face image you want to inpaint</p>
                  </div>
                  <div class="col-md-4">
                    <h5><i class="fas fa-paintbrush text-secondary"></i> Draw Mask</h5>
                    <p class="text-muted">Use the drawing tools to create masks over areas you want to inpaint</p>
                  </div>
                  <div class="col-md-4">
                    <h5><i class="fas fa-magic text-warning"></i> Process</h5>
                    <p class="text-muted">Click save to process the image with AI inpainting</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>Powered by <b>Sigmind.ai</b> | Advanced AI Face Inpainting Technology</p>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner mb-3"></div>
      <h4>Processing Image...</h4>
      <p class="text-muted">Please wait while we inpaint your image</p>
    </div>
  </div>

  <script>
    // Constants
    const MODE_DRAW = 0;
    const MODE_CROP = 1;

    // DOM Elements
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const brushSizeInput = document.getElementById('brushSize');
    const brushSizeValue = document.getElementById('brushSizeValue');
    const fileInput = document.getElementById('face_image');

    // State variables
    let mode = MODE_DRAW;
    let drawing = false;
    let brushSize = 5;
    let cropRect = {};
    let currentImage = null;

    // Set initial canvas size
    canvas.width = 512;
    canvas.height = 512;
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Handle image upload
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const formData = new FormData();
          formData.append('face_image', file);

          fetch('/process_image', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const img = new Image();
              img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                currentImage = img;
              };
              img.src = data.output_image;

              // Add fallback for .png extension if original is not found
              img.onerror = function() {
                const pngImage = data.output_image.replace(/\.\w+$/, '.png');
                img.src = pngImage;
                img.onload = function() {
                  canvas.width = img.width;
                  canvas.height = img.height;
                  ctx.drawImage(img, 0, 0);
                  currentImage = img;
                };
              };
            } else {
              console.error('Processing failed:', data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
        };
        reader.readAsDataURL(file);
      }
    });

    // Handle form submission
    document.getElementById('inpaintForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      canvas.toBlob(function(blob) {
        const formData = new FormData(e.target);
        formData.set('face_image', blob, 'edited_image.png');
        
        // Show loading overlay
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        fetch(e.target.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        })
        .then(response => {
          // Hide loading overlay
          document.getElementById('loadingOverlay').style.display = 'none';
          
          // Check if response is JSON
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            return response.json();
          } else {
            // If not JSON, reload the page to show the result
            window.location.reload();
            return;
          }
        })
        .then(data => {
          if (data && data.success) {
            // Create a new result section
            const contentArea = document.querySelector('.content-area');
            const existingResult = document.querySelector('.inpaint-result');
            if (existingResult) {
              existingResult.remove();
            }
            
            const resultSection = document.createElement('div');
            resultSection.className = 'inpaint-result';
            resultSection.innerHTML = `
              <div class="row mt-4">
                <div class="col-12">
                  <div class="card fade-in">
                    <div class="card-header">
                      <h3 class="card-title">
                        <i class="fas fa-check-circle text-success"></i>
                        Inpainting Complete
                      </h3>
                    </div>
                    <div class="card-body text-center">
                      <h4 class="mb-3">Inpainted Image</h4>
                      <img src="${data.output_image}" alt="Inpainted Face" class="image-preview shadow-lg">
                      <div class="mt-3">
                        <a href="${data.output_image}" download class="btn btn-outline">
                          <i class="fas fa-download"></i>
                          Download Result
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // Insert after the main form row
            const formRow = document.querySelector('.row');
            formRow.parentNode.insertBefore(resultSection, formRow.nextSibling);
            
            // Scroll to result
            resultSection.scrollIntoView({ behavior: 'smooth' });
          } else if (data) {
            alert(data.error || 'Failed to process image');
          }
        })
        .catch(error => {
          // Hide loading overlay
          document.getElementById('loadingOverlay').style.display = 'none';
          console.error('Error:', error);
          
          // Check if it's a network error or server error
          if (error.name === 'TypeError' && error.message.includes('JSON')) {
            // If JSON parsing failed, the server might have returned HTML
            // Reload the page to show the result
            window.location.reload();
          } else {
            alert('An error occurred while processing the image. Please try again.');
          }
        });
      });
    });

    // Handle brush size change
    brushSizeInput.addEventListener('input', function(e) {
      brushSize = parseInt(e.target.value);
      brushSizeValue.textContent = brushSize;
    });

    // Mouse event handlers
    canvas.addEventListener('mousedown', function(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (mode === MODE_DRAW) {
        drawing = true;
        drawSquare(x, y);
      } else if (mode === MODE_CROP) {
        cropRect.start = { x, y };
      }
    });

    canvas.addEventListener('mousemove', function(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (mode === MODE_DRAW && drawing) {
        drawSquare(x, y);
      } else if (mode === MODE_CROP && cropRect.start) {
        redrawCanvas();
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.strokeRect(
          cropRect.start.x,
          cropRect.start.y,
          x - cropRect.start.x,
          y - cropRect.start.y
        );
      }
    });

    canvas.addEventListener('mouseup', function(e) {
      if (mode === MODE_DRAW) {
        drawing = false;
      } else if (mode === MODE_CROP) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        cropRect.end = { x, y };
        applyCrop();
      }
    });

    // Drawing functions
    function drawSquare(x, y) {
      // Ensure we're using whole pixels
      x = Math.floor(x);
      y = Math.floor(y);
      
      // Turn off anti-aliasing
      ctx.imageSmoothingEnabled = false;
      
      // Use pure white with no transparency
      ctx.fillStyle = 'rgb(255, 255, 255)';
      
      // Draw with integer coordinates
      const halfSize = Math.floor(brushSize / 2);
      ctx.fillRect(
          x - halfSize,
          y - halfSize,
          brushSize,
          brushSize
      );
    }

    // Add this to the canvas initialization
    ctx.imageSmoothingEnabled = false;

    function redrawCanvas() {
      if (currentImage) {
        ctx.drawImage(currentImage, 0, 0);
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    function applyCrop() {
      if (cropRect.start && cropRect.end) {
        const x = Math.min(cropRect.start.x, cropRect.end.x);
        const y = Math.min(cropRect.start.y, cropRect.end.y);
        const width = Math.abs(cropRect.end.x - cropRect.start.x);
        const height = Math.abs(cropRect.end.y - cropRect.start.y);

        const imageData = ctx.getImageData(x, y, width, height);
        canvas.width = width;
        canvas.height = height;
        ctx.putImageData(imageData, 0, 0);

        cropRect = {};
        mode = MODE_DRAW;
      }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      switch (e.key.toLowerCase()) {
        case 'd':
          mode = MODE_DRAW;
          document.getElementById('drawMode').classList.add('active');
          document.getElementById('cropMode').classList.remove('active');
          break;
        case 'c':
          mode = MODE_CROP;
          cropRect = {};
          document.getElementById('cropMode').classList.add('active');
          document.getElementById('drawMode').classList.remove('active');
          break;
        case 's':
          document.getElementById('inpaintForm').dispatchEvent(new Event('submit'));
          break;
      }
    });

    // Button event listeners
    document.getElementById('drawMode').addEventListener('click', function() {
      mode = MODE_DRAW;
      this.classList.add('active');
      document.getElementById('cropMode').classList.remove('active');
    });

    document.getElementById('cropMode').addEventListener('click', function() {
      mode = MODE_CROP;
      cropRect = {};
      this.classList.add('active');
      document.getElementById('drawMode').classList.remove('active');
    });

    document.getElementById('clearCanvas').addEventListener('click', function() {
      redrawCanvas();
    });

    document.getElementById('save').addEventListener('click', function() {
      document.getElementById('inpaintForm').dispatchEvent(new Event('submit'));
    });
  </script>
</body>
</html>